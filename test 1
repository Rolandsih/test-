import json
import os
import asyncio
import schedule
import time
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters
import threading

TOKEN = "7693058383:AAFV8h7He90C_VLvEDJXnHhxaUQohzeDBT4"
PROMO_CODE = "SANA33"
CONTACT_LINK = "https://t.me/El_professormindst"
DATA_FILE = "users.json"
ADMIN_CHAT_ID = 1754828167  # Votre ID Telegram rÃ©el (entier, pas chaÃ®ne)

# Liens officiels ZACK PCS
INFO_LINK = "https://bot9082.github.io/Info-/"
TIPS_LINK = "https://bot9082.github.io/ZACK-CASH/"
PLATFORM_LINK = "https://1wlucb.life/casino/list/4?p=169j"

# Messages rotatifs personnalisÃ©s ZACK PCS
DAILY_MESSAGES = [
    """Hey {name} !  

ğŸ“Œ ZACK PCS - StratÃ©gies Casino Officielles ğŸ¯

ğŸ° Nouvelle astuce Aviator dÃ©tectÃ©e aujourd'hui !
â° Heures favorables : 14h-16h et 20h-22h
ğŸ”¥ Faille sur roulette europÃ©enne confirmÃ©e !
ğŸ’ Machines Ã  sous : patterns identifiÃ©s sur Book of Ra

ğŸ“š Infos complÃ¨tes : {info_link}
ğŸ“„ Astuces du jour : {tips_link}
ğŸ² Plateforme recommandÃ©e 1win : {platform_link}

ğŸ”‘ Code promo : **{promo}** pour activer tous les avantages !
ğŸ’¬ Support ZACK : {contact}""",

    """Salut {name} !  

ğŸ¯ ZACK PCS - Mise Ã  jour stratÃ©gies ğŸš€

ğŸ’° Gains observÃ©s : +850â‚¬ en 3h avec nos mÃ©thodes !
âš¡ Nouveau schÃ©ma dÃ©tectÃ© sur Crazy Time !
ğŸ² Roulette : mise sur secteurs chauds = 73% rÃ©ussite
ğŸ° Aviator : coefficient optimal entre x1.4 et x2.1

ğŸ“– Guide complet : {info_link}
ğŸ”¥ DerniÃ¨res astuces : {tips_link}
ğŸ† Inscription 1win : {platform_link}

âœ… Code **{promo}** = retraits rapides + bonus exclusifs
ğŸ“± Contact direct : {contact}""",

    """Hey {name} !  

ğŸ”¥ ZACK PCS - Alertes Failles Casino âš ï¸

ğŸ° URGENT : Faille Sweet Bonanza active jusqu'Ã  minuit !
ğŸ’ Machines progressives : jackpots prÃ¨s d'exploser !
ğŸ² Roulette live : dealer favorable identifiÃ© salle 3
â­ Aviator : algorithme prÃ©visible entre 18h-20h

ğŸ“‹ ProcÃ©dures dÃ©taillÃ©es : {info_link}
ğŸ’¯ StratÃ©gies actualisÃ©es : {tips_link}
ğŸ¯ Plateforme sÃ©curisÃ©e : {platform_link}

ğŸ”‘ OBLIGATOIRE : Code **{promo}** pour accÃ¨s complet
ğŸ“ Aide personnalisÃ©e : {contact}""",

    """Bonjour {name} !  

ğŸ’¸ ZACK PCS - RÃ©sultats Exceptionnels ğŸ“Š

ğŸš€ Record battu : +1,200â‚¬ en une session !
ğŸ° Aviator : 9 gains consÃ©cutifs avec notre timing
ğŸ”¥ Blackjack live : stratÃ©gie optimisÃ©e = 68% victoires
ğŸ’ Slots volatiles : moments idÃ©aux pour jouer gros

ğŸ“š MÃ©thodes complÃ¨tes : {info_link}
âš¡ Tips actualisÃ©s : {tips_link}
ğŸ… Compte optimisÃ© 1win : {platform_link}

âœ¨ Code **{promo}** = avantages VIP instantanÃ©s
ğŸ’¬ Questions ? Ã‰cris : {contact}""",

    """Coucou {name} !  

â­ ZACK PCS - OpportunitÃ©s LimitÃ©es â³

ğŸ¯ DERNIÃˆRES 6H : Faille mega jackpot disponible !
ğŸ’° Gains moyens constatÃ©s : +650â‚¬/jour avec nos tips
ğŸ² Roulette franÃ§aise : sÃ©rie rouge/noir prÃ©visible
ğŸ° Gates of Olympus : multiplicateurs x500 frÃ©quents

ğŸ“– AccÃ¨s formations : {info_link}
ğŸ”¥ Astuces temps rÃ©el : {tips_link}
ğŸª Interface optimale : {platform_link}

ğŸ”‘ Code magique **{promo}** pour dÃ©bloquer tout
ğŸ“² Support expert : {contact}"""
]


def load_users():
    """Charge les utilisateurs depuis le fichier JSON"""
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}


def save_users(users_data):
    """Sauvegarde les utilisateurs dans le fichier JSON"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(users_data, f, ensure_ascii=False, indent=2)


def get_user_name(update: Update):
    """RÃ©cupÃ¨re le nom/pseudo de l'utilisateur"""
    user = update.effective_user
    if user.first_name:
        return user.first_name
    elif user.username:
        return user.username
    else:
        return "ami"


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Commande /start - Accueille et enregistre l'utilisateur"""
    user_id = str(update.effective_user.id)
    user_name = get_user_name(update)

    # Charger les donnÃ©es existantes
    users_data = load_users()

    # Ajouter/mettre Ã  jour l'utilisateur
    users_data[user_id] = {
        "name": user_name,
        "username": update.effective_user.username,
        "registered_date": datetime.now().isoformat(),
        "last_message": None
    }

    # Sauvegarder
    save_users(users_data)

    welcome_message = f"""ğŸ“Œ Bienvenue {user_name} sur ZACK PCS !

ğŸ¯ Canal officiel dÃ©diÃ© aux stratÃ©gies et failles casino en ligne :
â€¢ Astuces testÃ©es sur Aviator, roulette, machines Ã  sous
â€¢ Heures favorables basÃ©es sur des schÃ©mas rÃ©els  
â€¢ Fuites et failles dÃ©tectÃ©es sur certaines plateformes
â€¢ Conseils pour optimiser tes chances

ğŸ“š Infos gÃ©nÃ©rales : {INFO_LINK}
ğŸ“„ Astuces du jour : {TIPS_LINK}
ğŸ² Plateforme recommandÃ©e 1win : {PLATFORM_LINK}

ğŸ’¬ Code promo : **{PROMO_CODE}** (compte russe nÃ©cessaire)
ğŸ“± Support direct : {CONTACT_LINK}

âš ï¸ Important : Les astuces sont basÃ©es sur des observations. Joue toujours avec responsabilitÃ©.

âœ… Tu recevras maintenant des conseils personnalisÃ©s quotidiens !"""

    await update.message.reply_text(welcome_message)


async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Commande /stats - Affiche les statistiques"""
    users_data = load_users()
    total_users = len(users_data)

    stats_message = f"""ğŸ“Š **Statistiques du bot :**

ğŸ‘¥ Total d'utilisateurs inscrits : **{total_users}**
ğŸ¯ Code promo actif : **{PROMO_CODE}**
ğŸ“… DerniÃ¨re mise Ã  jour : {datetime.now().strftime('%d/%m/%Y %H:%M')}"""

    await update.message.reply_text(stats_message)


def send_auto_message_to_admin():
    """Envoie un message automatique Ã  l'admin dans 4 minutes"""
    def send_message():
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        app = ApplicationBuilder().token(TOKEN).build()
        
        auto_message = """ğŸ¤– MESSAGE AUTOMATIQUE ZACK PCS

â° Il est temps de vÃ©rifier vos statistiques !
ğŸ“Š Consultez les nouveaux inscrits avec /stats
ğŸ¯ VÃ©rifiez les gains du jour sur vos plateformes
ğŸ’° N'oubliez pas de poster les nouvelles astuces !

ğŸ”¥ Votre bot fonctionne parfaitement !
ğŸ“± Restez connectÃ© pour plus d'opportunitÃ©s !"""

        try:
            loop.run_until_complete(app.bot.send_message(chat_id=int(ADMIN_CHAT_ID), text=auto_message))
            print(f"âœ… Message automatique envoyÃ© Ã  l'admin Ã  {datetime.now()}")
        except Exception as e:
            print(f"âŒ Erreur envoi message auto Ã  l'admin: {e}")
        finally:
            loop.close()
    
    # Programmer l'envoi dans 4 minutes
    timer = threading.Timer(240.0, send_message)  # 240 secondes = 4 minutes
    timer.start()

async def broadcast_daily_messages():
    """Envoie les messages quotidiens Ã  tous les utilisateurs + message test Ã  l'admin"""
    users_data = load_users()
    
    # Choisir un message du jour (rotation basÃ©e sur le jour de l'annÃ©e)
    day_of_year = datetime.now().timetuple().tm_yday
    message_template = DAILY_MESSAGES[day_of_year % len(DAILY_MESSAGES)]

    # CrÃ©er l'application pour envoyer des messages
    app = ApplicationBuilder().token(TOKEN).build()

    sent_count = 0
    
    # Si pas d'utilisateurs, envoyer un message test Ã  l'admin
    if not users_data:
        print("Aucun utilisateur enregistrÃ©, envoi d'un message test Ã  l'admin")
        try:
            test_message = f"""ğŸ§ª MESSAGE TEST ZACK PCS

ğŸ‘‹ Salut Admin ! Voici un exemple de message quotidien :

{message_template.format(
                name="Admin", 
                contact=CONTACT_LINK, 
                promo=PROMO_CODE,
                info_link=INFO_LINK,
                tips_link=TIPS_LINK,
                platform_link=PLATFORM_LINK
            )}

âœ… Le systÃ¨me de messages automatiques fonctionne parfaitement !
ğŸ“Š Utilisateurs inscrits : 0 pour le moment"""

            await app.bot.send_message(chat_id=int(ADMIN_CHAT_ID), text=test_message)
            print("âœ… Message test envoyÃ© Ã  l'admin")
            return
        except Exception as e:
            print(f"âŒ Erreur envoi message test Ã  l'admin: {e}")
            return

    # Envoyer aux utilisateurs enregistrÃ©s
    for user_id, user_data in users_data.items():
        try:
            # Personnaliser le message
            personalized_message = message_template.format(
                name=user_data["name"], 
                contact=CONTACT_LINK, 
                promo=PROMO_CODE,
                info_link=INFO_LINK,
                tips_link=TIPS_LINK,
                platform_link=PLATFORM_LINK
            )

            # Envoyer le message
            await app.bot.send_message(chat_id=int(user_id),
                                       text=personalized_message)

            # Mettre Ã  jour la date du dernier message
            users_data[user_id]["last_message"] = datetime.now().isoformat()
            sent_count += 1

            # Petite pause pour Ã©viter le spam
            await asyncio.sleep(1)

        except Exception as e:
            print(f"Erreur envoi message Ã  {user_id}: {e}")

    # Sauvegarder les mises Ã  jour
    save_users(users_data)
    print(f"Messages quotidiens envoyÃ©s Ã  {sent_count} utilisateurs")


async def send_test_message(update: Update,
                            context: ContextTypes.DEFAULT_TYPE):
    """Commande /test - Envoie un message test personnalisÃ©"""
    user_name = get_user_name(update)
    test_message = DAILY_MESSAGES[0].format(
        name=user_name,
        contact=CONTACT_LINK,
        promo=PROMO_CODE,
        info_link=INFO_LINK,
        tips_link=TIPS_LINK,
        platform_link=PLATFORM_LINK
    )
    await update.message.reply_text(f"ğŸ“§ **Message test :**\n\n{test_message}")


async def admin_panel_access(message_text, update: Update):
    """Fonction pour gÃ©rer l'accÃ¨s admin directement dans les messages"""
    
    # VÃ©rifier si c'est juste le nom (demande du code)
    if message_text == "SIHO ISAAC ROLAND":
        await update.message.reply_text(f"""ğŸ” **Administrateur dÃ©tectÃ© !**
        
ğŸ¯ Nom reconnu : **SIHO ISAAC ROLAND**
ğŸ”‘ Veuillez maintenant saisir votre code d'accÃ¨s personnel

âš ï¸ Tapez votre nom suivi de votre code secret pour continuer""")
        return True
    
    # VÃ©rifier l'authentification complÃ¨te
    if message_text == "SIHO ISAAC ROLAND 840106":
        # ACCÃˆS ADMIN AUTORISÃ‰ - Afficher le panneau complet
        users_data = load_users()
        current_time = datetime.now()
        
        # Message d'accueil admin
        admin_header = f"""ğŸ‘‘ **PANNEAU ADMINISTRATION - ZACK PCS**
ğŸ”“ AccÃ¨s autorisÃ© pour : **SIHO ISAAC ROLAND**
â° Connexion : {current_time.strftime('%d/%m/%Y Ã  %H:%M:%S')}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
        
        await update.message.reply_text(admin_header)
        
        # Statistiques gÃ©nÃ©rales du bot
        total_users = len(users_data)
        users_today = 0
        users_week = 0
        
        for user_data in users_data.values():
            reg_date = user_data.get("registered_date")
            if reg_date:
                try:
                    reg_datetime = datetime.fromisoformat(reg_date)
                    if reg_datetime.date() == current_time.date():
                        users_today += 1
                    if (current_time - reg_datetime).days <= 7:
                        users_week += 1
                except:
                    pass
        
        stats_message = f"""ğŸ“Š **STATISTIQUES DU BOT**

ğŸ‘¥ **Utilisateurs totaux :** {total_users}
ğŸ†• **Nouveaux aujourd'hui :** {users_today}
ğŸ“… **Cette semaine :** {users_week}
ğŸ”‘ **Code promo actif :** {PROMO_CODE}
ğŸ¤– **Status bot :** âœ… OpÃ©rationnel
â° **Messages auto :** 9h00 et 18h00
ğŸ”— **Plateforme liÃ©e :** 1win Casino

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
        
        await update.message.reply_text(stats_message)
        
        if not users_data:
            await update.message.reply_text("ğŸ“ **Aucun utilisateur enregistrÃ© pour le moment.**")
            return True
        
        # Liste dÃ©taillÃ©e des utilisateurs
        users_list = "ğŸ‘¥ **LISTE DÃ‰TAILLÃ‰E DES UTILISATEURS :**\n\n"
        
        for i, (user_id, user_data) in enumerate(users_data.items(), 1):
            registered_date = user_data.get("registered_date", "Inconnue")
            if registered_date != "Inconnue":
                try:
                    date_obj = datetime.fromisoformat(registered_date)
                    formatted_date = date_obj.strftime("%d/%m/%Y Ã  %H:%M")
                except:
                    formatted_date = "Date invalide"
            else:
                formatted_date = "Inconnue"
            
            last_message = user_data.get("last_message", "Jamais")
            if last_message != "Jamais":
                try:
                    last_msg_obj = datetime.fromisoformat(last_message)
                    last_msg_formatted = last_msg_obj.strftime("%d/%m/%Y Ã  %H:%M")
                except:
                    last_msg_formatted = "Date invalide"
            else:
                last_msg_formatted = "Jamais"
            
            users_list += f"""**{i}.** {user_data.get('name', 'Nom inconnu')}
ğŸ“± ID: `{user_id}`
ğŸ‘¤ Username: @{user_data.get('username', 'Aucun')}
ğŸ“… Inscrit: {formatted_date}
ğŸ“§ Dernier message: {last_msg_formatted}
â–â–â–â–â–â–â–â–â–â–

"""
        
        users_list += f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š **RÃ‰SUMÃ‰ FINAL**
ğŸ¯ Total utilisateurs : **{len(users_data)}**
ğŸ‘‘ Admin connectÃ© : **SIHO ISAAC ROLAND**
ğŸ” SÃ©curitÃ© : âœ… Code 840106 validÃ©"""
        
        # Envoyer en plusieurs messages si trop long
        if len(users_list) > 4000:
            chunks = [users_list[i:i+4000] for i in range(0, len(users_list), 4000)]
            for chunk in chunks:
                await update.message.reply_text(chunk)
        else:
            await update.message.reply_text(users_list)
        
        return True
    
    return False


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Commande /help"""
    help_text = f"""ğŸ¤– **Commandes disponibles :**

/start - S'inscrire et recevoir l'accueil
/test - Voir un exemple de message quotidien
/stats - Voir les statistiques
/help - Cette aide

ğŸ”‘ **Code promo :** {PROMO_CODE}
ğŸ“± **Support :** {CONTACT_LINK}

âœ… Les messages personnalisÃ©s sont envoyÃ©s automatiquement chaque jour !"""

    await update.message.reply_text(help_text)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Gestion des messages non-commandes"""
    message_text = update.message.text
    message_text_lower = message_text.lower()
    user_name = get_user_name(update)

    # PRIORITÃ‰ 1 : VÃ©rifier l'accÃ¨s admin direct (nom exact)
    admin_handled = await admin_panel_access(message_text, update)
    if admin_handled:
        return

    # Code secret pour test instantanÃ©
    if "111222" in message_text_lower:
        await update.message.reply_text("ğŸ§ª TEST INSTANTANÃ‰ ACTIVÃ‰ ! Message automatique dans 10 secondes...")
        
        # Programmer un message de test dans 10 secondes
        def send_instant_test():
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            
            app = ApplicationBuilder().token(TOKEN).build()
            
            # Choisir un message alÃ©atoire
            import random
            test_message_template = random.choice(DAILY_MESSAGES)
            
            instant_message = f"""ğŸ”¥ TEST INSTANTANÃ‰ RÃ‰USSI ! 

{test_message_template.format(
                name=user_name, 
                contact=CONTACT_LINK, 
                promo=PROMO_CODE,
                info_link=INFO_LINK,
                tips_link=TIPS_LINK,
                platform_link=PLATFORM_LINK
            )}

âœ… Votre bot fonctionne parfaitement !
ğŸ¯ Les messages automatiques sont opÃ©rationnels !"""

            try:
                loop.run_until_complete(app.bot.send_message(chat_id=update.effective_chat.id, text=instant_message))
                print(f"âœ… Message de test instantanÃ© envoyÃ© Ã  {user_name}")
            except Exception as e:
                print(f"âŒ Erreur test instantanÃ©: {e}")
            finally:
                loop.close()
        
        # Lancer dans 10 secondes
        timer = threading.Timer(10.0, send_instant_test)
        timer.start()
        
    elif PROMO_CODE.lower() in message_text_lower:
        await update.message.reply_text(
            f"ğŸ¯ Parfait {user_name} ! Tu as mentionnÃ© le code {PROMO_CODE}. Tu es dans le bon chemin pour maximiser tes gains ! ğŸ’°"
        )
    elif any(word in message_text_lower
             for word in ["aide", "help", "problÃ¨me", "question"]):
        await update.message.reply_text(
            f"ğŸ“ {user_name}, je suis lÃ  pour t'aider ! Contacte-moi directement : {CONTACT_LINK}"
        )
    elif any(word in message_text_lower for word in ["merci", "thanks"]):
        await update.message.reply_text(
            f"ğŸ™ De rien {user_name} ! Continue comme Ã§a, les gains vont exploser ! ğŸš€"
        )


def schedule_daily_messages():
    """Programme les messages quotidiens"""
    def run_broadcast():
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        loop.run_until_complete(broadcast_daily_messages())
        loop.close()

    schedule.every().day.at("09:00").do(run_broadcast)
    schedule.every().day.at("18:00").do(run_broadcast)
    
    # Message test dans 2 minutes pour vÃ©rifier que Ã§a marche
    import datetime
    test_time = (datetime.datetime.now() + datetime.timedelta(minutes=2)).strftime("%H:%M")
    schedule.every().day.at(test_time).do(run_broadcast)

    while True:
        schedule.run_pending()
        time.sleep(30)  # VÃ©rifier toutes les 30 secondes


if __name__ == "__main__":
    print("ğŸš€ DÃ©marrage du bot ZACK PCS...")

    # CrÃ©ation de l'application
    app = ApplicationBuilder().token(TOKEN).build()

    # Ajout des handlers
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("stats", stats))
    app.add_handler(CommandHandler("test", send_test_message))
    app.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # DÃ©marrer le scheduler dans un thread sÃ©parÃ©
    scheduler_thread = threading.Thread(target=schedule_daily_messages,
                                        daemon=True)
    scheduler_thread.start()
    
    # DÃ©marrer le message automatique dans 4 minutes
    send_auto_message_to_admin()

    print("ğŸ¤– Bot ZACK PCS dÃ©marrÃ© ! En attente de nouveaux utilisateurs...")
    print(f"ğŸ“§ Messages automatiques programmÃ©s Ã  9h et 18h")
    print(f"â° Message automatique Ã  l'admin dans 4 minutes")
    print(f"ğŸ”‘ Code promo actif : {PROMO_CODE}")

    # DÃ©marrage du bot
    app.run_polling()
